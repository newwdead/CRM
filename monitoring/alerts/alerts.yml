groups:
  # System Alerts
  - name: system_alerts
    interval: 30s
    rules:
      # CPU Alert
      - alert: HighCPUUsage
        expr: 100 - (avg by (instance) (irate(node_cpu_seconds_total{mode="idle"}[5m])) * 100) > 80
        for: 5m
        labels:
          severity: warning
          category: system
        annotations:
          summary: "High CPU usage detected"
          description: "CPU usage is {{ $value | humanize }}% on {{ $labels.instance }}"
          
      # Memory Alert
      - alert: HighMemoryUsage
        expr: (node_memory_MemTotal_bytes - node_memory_MemAvailable_bytes) / node_memory_MemTotal_bytes * 100 > 85
        for: 5m
        labels:
          severity: warning
          category: system
        annotations:
          summary: "High memory usage detected"
          description: "Memory usage is {{ $value | humanize }}% on {{ $labels.instance }}"
          
      # Critical Memory Alert
      - alert: CriticalMemoryUsage
        expr: (node_memory_MemTotal_bytes - node_memory_MemAvailable_bytes) / node_memory_MemTotal_bytes * 100 > 95
        for: 2m
        labels:
          severity: critical
          category: system
        annotations:
          summary: "CRITICAL: Memory usage is extremely high"
          description: "Memory usage is {{ $value | humanize }}% on {{ $labels.instance }}"
          
      # Disk Space Alert
      - alert: DiskSpaceLow
        expr: (node_filesystem_size_bytes{fstype=~"ext.|xfs"} - node_filesystem_free_bytes) / node_filesystem_size_bytes * 100 > 80
        for: 10m
        labels:
          severity: warning
          category: system
        annotations:
          summary: "Disk space is running low"
          description: "Disk {{ $labels.mountpoint }} is {{ $value | humanize }}% full on {{ $labels.instance }}"
          
      # Critical Disk Space Alert
      - alert: DiskSpaceCritical
        expr: (node_filesystem_size_bytes{fstype=~"ext.|xfs"} - node_filesystem_free_bytes) / node_filesystem_size_bytes * 100 > 90
        for: 5m
        labels:
          severity: critical
          category: system
        annotations:
          summary: "CRITICAL: Disk space is critically low"
          description: "Disk {{ $labels.mountpoint }} is {{ $value | humanize }}% full on {{ $labels.instance }}"
          
      # System Load Alert
      - alert: HighSystemLoad
        expr: node_load15 / count(node_cpu_seconds_total{mode="idle"}) > 2
        for: 10m
        labels:
          severity: warning
          category: system
        annotations:
          summary: "System load is high"
          description: "Load average (15m) is {{ $value | humanize }} on {{ $labels.instance }}"

  # Docker Alerts
  - name: docker_alerts
    interval: 30s
    rules:
      # Container CPU Alert
      - alert: ContainerHighCPU
        expr: sum(rate(container_cpu_usage_seconds_total{name=~".+"}[5m])) by (name) * 100 > 80
        for: 5m
        labels:
          severity: warning
          category: docker
        annotations:
          summary: "Container {{ $labels.name }} has high CPU usage"
          description: "Container CPU usage is {{ $value | humanize }}%"
          
      # Container Memory Alert
      - alert: ContainerHighMemory
        expr: container_memory_usage_bytes{name=~".+"} > 1073741824
        for: 5m
        labels:
          severity: warning
          category: docker
        annotations:
          summary: "Container {{ $labels.name }} has high memory usage"
          description: "Container memory usage is {{ $value | humanize1024 }}"
          
      # Container Restart Alert
      - alert: ContainerRestarted
        expr: rate(container_start_time_seconds{name=~".+"}[5m]) > 0
        for: 1m
        labels:
          severity: warning
          category: docker
        annotations:
          summary: "Container {{ $labels.name }} was restarted"
          description: "Container has been restarted recently"

  # Database Alerts
  - name: database_alerts
    interval: 30s
    rules:
      # PostgreSQL Down
      - alert: PostgreSQLDown
        expr: pg_up == 0
        for: 1m
        labels:
          severity: critical
          category: database
        annotations:
          summary: "PostgreSQL is down"
          description: "PostgreSQL database is not responding"
          
      # PostgreSQL Connections High
      - alert: PostgreSQLHighConnections
        expr: pg_stat_database_numbackends{datname="businesscards"} / pg_settings_max_connections * 100 > 80
        for: 5m
        labels:
          severity: warning
          category: database
        annotations:
          summary: "PostgreSQL connections are high"
          description: "{{ $value | humanize }}% of max connections are in use"
          
      # PostgreSQL Deadlocks
      - alert: PostgreSQLDeadlocks
        expr: rate(pg_stat_database_deadlocks{datname="businesscards"}[5m]) > 0
        for: 1m
        labels:
          severity: warning
          category: database
        annotations:
          summary: "PostgreSQL deadlocks detected"
          description: "Deadlocks are occurring in the database"
          
      # PostgreSQL Cache Hit Ratio Low
      - alert: PostgreSQLLowCacheHitRatio
        expr: pg_stat_database_blks_hit{datname="businesscards"} / (pg_stat_database_blks_hit{datname="businesscards"} + pg_stat_database_blks_read{datname="businesscards"}) * 100 < 90
        for: 10m
        labels:
          severity: warning
          category: database
        annotations:
          summary: "PostgreSQL cache hit ratio is low"
          description: "Cache hit ratio is {{ $value | humanize }}%"
          
      # Redis Down
      - alert: RedisDown
        expr: redis_up == 0
        for: 1m
        labels:
          severity: critical
          category: database
        annotations:
          summary: "Redis is down"
          description: "Redis cache is not responding"
          
      # Redis Memory High
      - alert: RedisHighMemory
        expr: redis_memory_used_bytes / redis_memory_max_bytes * 100 > 80
        for: 5m
        labels:
          severity: warning
          category: database
        annotations:
          summary: "Redis memory usage is high"
          description: "Redis is using {{ $value | humanize }}% of max memory"

  # Application Alerts
  - name: application_alerts
    interval: 30s
    rules:
      # Application Down
      - alert: ApplicationDown
        expr: up{job="fastapi-backend"} == 0
        for: 1m
        labels:
          severity: critical
          category: application
        annotations:
          summary: "FastAPI application is down"
          description: "The application is not responding"
          
      # High Error Rate
      - alert: HighErrorRate
        expr: sum(rate(http_requests_total{status=~"5.."}[5m])) / sum(rate(http_requests_total[5m])) * 100 > 5
        for: 5m
        labels:
          severity: critical
          category: application
        annotations:
          summary: "High error rate detected"
          description: "Error rate is {{ $value | humanize }}%"
          
      # Slow Response Time
      - alert: SlowResponseTime
        expr: histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m])) > 2
        for: 10m
        labels:
          severity: warning
          category: application
        annotations:
          summary: "Slow response time detected"
          description: "95th percentile response time is {{ $value | humanize }}s"
          
      # High Request Rate
      - alert: HighRequestRate
        expr: sum(rate(http_requests_total[5m])) > 100
        for: 5m
        labels:
          severity: warning
          category: application
        annotations:
          summary: "High request rate detected"
          description: "Request rate is {{ $value | humanize }} req/s"

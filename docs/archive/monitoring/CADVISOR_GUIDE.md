# ๐ cAdvisor - ะัะบะพะฒะพะดััะฒะพ ะฟะพ ะผะพะฝะธัะพัะธะฝะณั Docker ะบะพะฝัะตะนะฝะตัะพะฒ

## ๐ ะงัะพ ัะฐะบะพะต cAdvisor?

**cAdvisor** (Container Advisor) - ััะพ ะธะฝััััะผะตะฝั ะพั Google ะดะปั ะผะพะฝะธัะพัะธะฝะณะฐ Docker ะบะพะฝัะตะนะฝะตัะพะฒ ะฒ ัะตะฐะปัะฝะพะผ ะฒัะตะผะตะฝะธ.

### ะัะฝะพะฒะฝะฐั ะธะฝัะพัะผะฐัะธั:
- **ะะฐะทัะฐะฑะพััะธะบ:** Google
- **ะะฐะทะฝะฐัะตะฝะธะต:** ะะฝะฐะปะธะท ะธัะฟะพะปัะทะพะฒะฐะฝะธั ัะตััััะพะฒ ะบะพะฝัะตะนะฝะตัะฐะผะธ
- **ะะธัะตะฝะทะธั:** Apache 2.0 (Open Source)
- **ะัะธัะธะฐะปัะฝัะน ัะฐะนั:** https://github.com/google/cadvisor

---

## ๐ก ะะปั ัะตะณะพ ะธัะฟะพะปัะทัะตััั?

cAdvisor ัะพะฑะธัะฐะตั, ะพะฑัะฐะฑะฐััะฒะฐะตั ะธ ะฟัะตะดะพััะฐะฒะปัะตั ะผะตััะธะบะธ ะพ:

### ๐ ะะตััััั:
- **CPU** - ะธัะฟะพะปัะทะพะฒะฐะฝะธะต ะฟัะพัะตััะพัะฐ ะบะฐะถะดัะผ ะบะพะฝัะตะนะฝะตัะพะผ
- **Memory** - ะฟะพััะตะฑะปะตะฝะธะต ะพะฟะตัะฐัะธะฒะฝะพะน ะฟะฐะผััะธ
- **Network** - ัะตัะตะฒะพะน ััะฐัะธะบ (ะฒัะพะดััะธะน/ะธััะพะดััะธะน)
- **Disk I/O** - ะพะฟะตัะฐัะธะธ ััะตะฝะธั/ะทะฐะฟะธัะธ ะฝะฐ ะดะธัะบ
- **Filesystem** - ะธัะฟะพะปัะทะพะฒะฐะฝะธะต ะดะธัะบะพะฒะพะณะพ ะฟัะพัััะฐะฝััะฒะฐ

### ๐ฏ ะัะพัะตััั:
- ะะพะปะธัะตััะฒะพ ะทะฐะฟััะตะฝะฝัั ะฟัะพัะตััะพะฒ ะฒ ะบะพะฝัะตะนะฝะตัะต
- ะกะพััะพัะฝะธะต ะบะพะฝัะตะนะฝะตัะพะฒ (running, stopped, etc.)
- ะััะพัะธั ะฟะตัะตะทะฐะฟััะบะพะฒ

---

## ๐๏ธ ะะฐะบ ัะฐะฑะพัะฐะตั ะฒ ะฒะฐัะตะน ัะธััะตะผะต?

### ะััะธัะตะบัััะฐ:

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                    Docker Host                          โ
โ                                                         โ
โ  โโโโโโโโโโโโ  โโโโโโโโโโโโ  โโโโโโโโโโโโ             โ
โ  โ Backend  โ  โ Frontend โ  โ   Redis  โ  ...        โ
โ  โContainer โ  โContainer โ  โContainer โ             โ
โ  โโโโโโฌโโโโโโ  โโโโโโฌโโโโโโ  โโโโโโฌโโโโโโ             โ
โ       โ             โ             โ                    โ
โ       โโโโโโโโโโโโโโโดโโโโโโโโโโโโโโ                    โ
โ                     โ                                  โ
โ         โโโโโโโโโโโโโผโโโโโโโโโโโโโโโ                   โ
โ         โ      cAdvisor :8080      โ โ ัะพะฑะธัะฐะตั ะผะตััะธะบะธโ
โ         โโโโโโโโโโโโโฌโโโโโโโโโโโโโโโ                   โ
โ                     โ                                  โ
โ         โโโโโโโโโโโโโผโโโโโโโโโโโโโโโ                   โ
โ         โ   Prometheus :9090       โ โ ััะฐะฝะธั ะผะตััะธะบะธ  โ
โ         โโโโโโโโโโโโโฌโโโโโโโโโโโโโโโ                   โ
โ                     โ                                  โ
โ         โโโโโโโโโโโโโผโโโโโโโโโโโโโโโ                   โ
โ         โ     Grafana :3001        โ โ ะฒะธะทัะฐะปะธะทะฐัะธั   โ
โ         โโโโโโโโโโโโโโโโโโโโโโโโโโโโ                   โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

### ะะพะฝัะธะณััะฐัะธั (docker-compose.monitoring.yml):

```yaml
cadvisor:
  image: gcr.io/cadvisor/cadvisor:latest
  container_name: bizcard-cadvisor
  restart: unless-stopped
  privileged: true  # โ ะฝัะถะตะฝ ะดะพัััะฟ ะบ ัะธััะตะผะต
  ports:
    - "8080:8080"
  volumes:
    - /:/rootfs:ro           # โ ััะตะฝะธะต ะบะพัะฝะตะฒะพะน ะคะก
    - /var/run:/var/run:ro   # โ Docker socket
    - /sys:/sys:ro           # โ ัะธััะตะผะฝะฐั ะธะฝัะพัะผะฐัะธั
    - /var/lib/docker/:/var/lib/docker:ro  # โ Docker ะดะฐะฝะฝัะต
  command:
    - '--housekeeping_interval=10s'  # โ ะบะฐะถะดัะต 10 ัะตะบ
    - '--docker_only=true'           # โ ัะพะปัะบะพ Docker
```

---

## ๐ ะะฐะบ ะธัะฟะพะปัะทะพะฒะฐัั?

### 1. ะะตะฑ-ะธะฝัะตััะตะนั cAdvisor

**URL:** http://ibbase.ru:8080

**ะงัะพ ะผะพะถะฝะพ ะฟะพัะผะพััะตัั:**
- ๐ ะะฐัะฑะพัะด ัะพ ะฒัะตะผะธ ะบะพะฝัะตะนะฝะตัะฐะผะธ
- ๐ ะัะฐัะธะบะธ ะธัะฟะพะปัะทะพะฒะฐะฝะธั ัะตััััะพะฒ ะฒ ัะตะฐะปัะฝะพะผ ะฒัะตะผะตะฝะธ
- ๐ ะะตัะฐะปัะฝะฐั ะธะฝัะพัะผะฐัะธั ะพ ะบะฐะถะดะพะผ ะบะพะฝัะตะนะฝะตัะต
- ๐ ะััะพัะธั ะทะฐ ะฟะพัะปะตะดะฝะธะต 60 ัะตะบัะฝะด

**ะัะธะผะตั ะฟัะพัะผะพััะฐ:**
```
http://ibbase.ru:8080
โโโ / (ะบะพัะตะฝั) - ัะฟะธัะพะบ ะฒัะตั ะบะพะฝัะตะนะฝะตัะพะฒ
โโโ /docker/ - ัะพะปัะบะพ Docker ะบะพะฝัะตะนะฝะตัั
โ   โโโ /docker/<container-id> - ะดะตัะฐะปะธ ะบะพะฝัะตะนะฝะตัะฐ
โ   โโโ /docker/<container-name>
โโโ /metrics - ะผะตััะธะบะธ ะดะปั Prometheus
```

### 2. REST API

**ะะฐะทะพะฒัะน URL:** http://localhost:8080/api/v1.3/

**ะัะฝะพะฒะฝัะต endpoints:**

```bash
# ะกะฟะธัะพะบ ะฒัะตั Docker ะบะพะฝัะตะนะฝะตัะพะฒ
curl http://localhost:8080/api/v1.3/docker/

# ะะฝัะพัะผะฐัะธั ะพ ะบะพะฝะบัะตัะฝะพะผ ะบะพะฝัะตะนะฝะตัะต
curl http://localhost:8080/api/v1.3/docker/<container-name>

# ะัะธะผะตั: ะผะตััะธะบะธ backend ะบะพะฝัะตะนะฝะตัะฐ
curl http://localhost:8080/api/v1.3/docker/bizcard-backend

# ะะตััะธะบะธ ัะธััะตะผั
curl http://localhost:8080/api/v1.3/machine
```

**ะคะพัะผะฐั ะพัะฒะตัะฐ (JSON):**
```json
{
  "id": "container-id",
  "name": "bizcard-backend",
  "aliases": ["backend"],
  "spec": {
    "cpu": { "limit": 2597, "mask": "0-1" },
    "memory": { "limit": 8589934592 }
  },
  "stats": [
    {
      "timestamp": "2025-10-25T10:00:00Z",
      "cpu": {
        "usage": {
          "total": 1234567890,
          "per_cpu_usage": [500000000, 734567890]
        }
      },
      "memory": {
        "usage": 536870912,
        "working_set": 536870912
      },
      "network": {
        "rx_bytes": 123456789,
        "tx_bytes": 987654321
      }
    }
  ]
}
```

### 3. ะะฝัะตะณัะฐัะธั ั Prometheus

cAdvisor ะฐะฒัะพะผะฐัะธัะตัะบะธ ัะบัะฟะพััะธััะตั ะผะตััะธะบะธ ะดะปั Prometheus:

**URL ะผะตััะธะบ:** http://localhost:8080/metrics

**Prometheus ะบะพะฝัะธะณััะฐัะธั** (ัะถะต ะฝะฐัััะพะตะฝะฐ):
```yaml
scrape_configs:
  - job_name: 'cadvisor'
    scrape_interval: 15s
    static_configs:
      - targets: ['cadvisor:8080']
```

**ะะพัััะฟะฝัะต ะผะตััะธะบะธ ะฒ Prometheus:**
- `container_cpu_usage_seconds_total`
- `container_memory_usage_bytes`
- `container_network_receive_bytes_total`
- `container_network_transmit_bytes_total`
- `container_fs_usage_bytes`

### 4. ะะธะทัะฐะปะธะทะฐัะธั ะฒ Grafana

**URL:** https://monitoring.ibbase.ru

**ะะพัะพะฒัะต ะดะฐัะฑะพัะดั ะดะปั ะธะผะฟะพััะฐ:**
- **ID: 893** - Docker monitoring via cAdvisor
- **ID: 14282** - Docker Container & Host Metrics

**ะะฐะบ ะธะผะฟะพััะธัะพะฒะฐัั:**
1. ะัะบัะพะนัะต Grafana โ Dashboards โ Import
2. ะะฒะตะดะธัะต ID ะดะฐัะฑะพัะดะฐ (ะฝะฐะฟัะธะผะตั, 893)
3. ะัะฑะตัะธัะต Prometheus ะบะฐะบ data source
4. ะะฐะถะผะธัะต Import

---

## ๐ ะัะฐะบัะธัะตัะบะธะต ะฟัะธะผะตัั

### ะัะธะผะตั 1: ะะพะฝะธัะพัะธะฝะณ CPU ะฒัะตั ะบะพะฝัะตะนะฝะตัะพะฒ

**Prometheus Query:**
```promql
# ะัะพัะตะฝั ะธัะฟะพะปัะทะพะฒะฐะฝะธั CPU ะฟะพ ะบะพะฝัะตะนะฝะตัะฐะผ
sum(rate(container_cpu_usage_seconds_total[1m])) by (name) * 100
```

**ะะตะทัะปััะฐั:**
```
bizcard-backend:  45%
bizcard-frontend: 12%
bizcard-db:       8%
bizcard-redis:    3%
```

### ะัะธะผะตั 2: ะขะพะฟ-5 ะบะพะฝัะตะนะฝะตัะพะฒ ะฟะพ ะฟะฐะผััะธ

**Prometheus Query:**
```promql
# ะขะพะฟ 5 ะบะพะฝัะตะนะฝะตัะพะฒ ะฟะพ ะธัะฟะพะปัะทะพะฒะฐะฝะธั ะฟะฐะผััะธ
topk(5, container_memory_usage_bytes{name!=""})
```

### ะัะธะผะตั 3: ะกะตัะตะฒะพะน ััะฐัะธะบ

**Prometheus Query:**
```promql
# ะัะพะดััะธะน ััะฐัะธะบ (MB/s)
sum(rate(container_network_receive_bytes_total[5m])) by (name) / 1024 / 1024

# ะััะพะดััะธะน ััะฐัะธะบ (MB/s)
sum(rate(container_network_transmit_bytes_total[5m])) by (name) / 1024 / 1024
```

### ะัะธะผะตั 4: Alert ะฝะฐ ะฒััะพะบะพะต ะธัะฟะพะปัะทะพะฒะฐะฝะธะต ะฟะฐะผััะธ

**Prometheus Alert:**
```yaml
- alert: ContainerHighMemory
  expr: |
    container_memory_usage_bytes{name!=""} 
    / 
    container_spec_memory_limit_bytes > 0.9
  for: 5m
  labels:
    severity: warning
  annotations:
    summary: "Container {{ $labels.name }} high memory usage"
    description: "{{ $labels.name }} is using {{ $value }}% of memory limit"
```

---

## ๐ง ะะพะผะฐะฝะดั ะดะปั ัะฟัะฐะฒะปะตะฝะธั

### ะะฐะฟััะบ cAdvisor:
```bash
cd /home/ubuntu/fastapi-bizcard-crm-ready
docker compose -f docker-compose.monitoring.yml up -d cadvisor
```

### ะััะฐะฝะพะฒะบะฐ:
```bash
docker compose -f docker-compose.monitoring.yml stop cadvisor
```

### ะะตัะตะทะฐะฟััะบ:
```bash
docker compose -f docker-compose.monitoring.yml restart cadvisor
```

### ะัะพัะผะพัั ะปะพะณะพะฒ:
```bash
docker logs bizcard-cadvisor -f
```

### ะัะพะฒะตัะบะฐ ััะฐัััะฐ:
```bash
docker ps | grep cadvisor
curl -s http://localhost:8080/healthz
```

---

## ๐ ะงัะพ ะผะพะฝะธัะพัะธัั ะฒ ะฟะตัะฒัั ะพัะตัะตะดั?

### 1. **CPU Usage** (ะทะฐะณััะทะบะฐ ะฟัะพัะตััะพัะฐ)
- **ะะพัะผะฐะปัะฝะพ:** < 70%
- **ะะฝะธะผะฐะฝะธะต:** 70-90%
- **ะัะธัะธัะฝะพ:** > 90%

**ะงัะพ ะดะตะปะฐัั ะตัะปะธ ะฒััะพะบะฐั:**
- ะะฟัะธะผะธะทะธัะพะฒะฐัั ะบะพะด
- ะะพะฑะฐะฒะธัั ะบะตัะธัะพะฒะฐะฝะธะต
- ะะฐัััะฐะฑะธัะพะฒะฐัั ะณะพัะธะทะพะฝัะฐะปัะฝะพ (ะฑะพะปััะต ะบะพะฝัะตะนะฝะตัะพะฒ)

### 2. **Memory Usage** (ะฟะฐะผััั)
- **ะะพัะผะฐะปัะฝะพ:** < 80% ะพั ะปะธะผะธัะฐ
- **ะะฝะธะผะฐะฝะธะต:** 80-95%
- **ะัะธัะธัะฝะพ:** > 95%

**ะงัะพ ะดะตะปะฐัั ะตัะปะธ ะฒััะพะบะฐั:**
- ะะฐะนัะธ ััะตัะบะธ ะฟะฐะผััะธ
- ะฃะฒะตะปะธัะธัั ะปะธะผะธัั
- ะะฟัะธะผะธะทะธัะพะฒะฐัั ะทะฐะฟัะพัั ะบ ะะ

### 3. **Network I/O** (ัะตัั)
- **ะะพัะผะฐะปัะฝะพ:** ััะฐะฑะธะปัะฝัะน ััะฐัะธะบ
- **ะะฝะธะผะฐะฝะธะต:** ัะตะทะบะธะต ัะบะฐัะบะธ
- **ะัะธัะธัะฝะพ:** ะฟะพััะพัะฝะฝัะต 100 ะะฑะธั/ั+

**ะงัะพ ะดะตะปะฐัั:**
- ะัะพะฒะตัะธัั ะฐัะฐะบะธ (DDoS)
- ะะฟัะธะผะธะทะธัะพะฒะฐัั API ะทะฐะฟัะพัั
- ะัะฟะพะปัะทะพะฒะฐัั CDN ะดะปั ััะฐัะธะบะธ

### 4. **Disk I/O** (ะดะธัะบ)
- **ะะพัะผะฐะปัะฝะพ:** < 80% IOPS
- **ะะฝะธะผะฐะฝะธะต:** ะฟะพััะพัะฝะฝะฐั ะทะฐะฟะธัั/ััะตะฝะธะต
- **ะัะธัะธัะฝะพ:** ะพัะตัะตะดั ะพะฟะตัะฐัะธะน > 10

**ะงัะพ ะดะตะปะฐัั:**
- ะะฟัะธะผะธะทะธัะพะฒะฐัั SQL ะทะฐะฟัะพัั
- ะะพะฑะฐะฒะธัั ะธะฝะดะตะบัั ะฒ ะะ
- ะัะฟะพะปัะทะพะฒะฐัั SSD ะฒะผะตััะพ HDD

---

## ๐ฏ Best Practices

### โ ะะตะบะพะผะตะฝะดะฐัะธะธ:

1. **ะะตะณัะปััะฝัะน ะผะพะฝะธัะพัะธะฝะณ**
   - ะัะพะฒะตััะนัะต ะดะฐัะฑะพัะดั ะผะธะฝะธะผัะผ ัะฐะท ะฒ ะดะตะฝั
   - ะะฐัััะพะนัะต ะฐะปะตััั ะฝะฐ ะบัะธัะธัะฝัะต ะผะตััะธะบะธ

2. **ะััะพัะธัะตัะบะฐั ะฐะฝะฐะปะธัะธะบะฐ**
   - Prometheus ััะฐะฝะธั ะดะฐะฝะฝัะต 15 ะดะฝะตะน
   - ะญะบัะฟะพััะธััะนัะต ะฒ long-term storage ะตัะปะธ ะฝัะถะฝะพ ะฑะพะปััะต

3. **Capacity Planning**
   - ะะฝะฐะปะธะทะธััะนัะต ััะตะฝะดั ะธัะฟะพะปัะทะพะฒะฐะฝะธั ัะตััััะพะฒ
   - ะะปะฐะฝะธััะนัะต ะผะฐัััะฐะฑะธัะพะฒะฐะฝะธะต ะทะฐัะฐะฝะตะต

4. **ะะฟัะธะผะธะทะฐัะธั**
   - ะัะฟะพะปัะทัะนัะต ะผะตััะธะบะธ ะดะปั ะฟะพะธัะบะฐ ัะทะบะธั ะผะตัั
   - ะัะธะผะตะฝัะนัะต ะธะทะผะตะฝะตะฝะธั ะฟะพััะตะฟะตะฝะฝะพ
   - ะะทะผะตััะนัะต ัะตะทัะปััะฐัั

5. **ะะปะตััั**
   - ะะต ัะพะทะดะฐะฒะฐะนัะต ัะปะธัะบะพะผ ะผะฝะพะณะพ ะฐะปะตััะพะฒ (alert fatigue)
   - ะััะฟะฟะธััะนัะต ะฟะพัะพะถะธะต ะฟัะพะฑะปะตะผั
   - ะะพะฑะฐะฒะปัะนัะต ะธะฝััััะบัะธะธ ะฟะพ ััััะฐะฝะตะฝะธั

---

## ๐ ะะพะปะตะทะฝัะต ัััะปะบะธ

- **ะัะธัะธะฐะปัะฝะฐั ะดะพะบัะผะตะฝัะฐัะธั:** https://github.com/google/cadvisor/blob/master/docs/
- **API Reference:** https://github.com/google/cadvisor/blob/master/docs/api.md
- **Prometheus Integration:** https://github.com/google/cadvisor/blob/master/docs/storage/prometheus.md
- **Grafana Dashboards:** https://grafana.com/grafana/dashboards/?search=cadvisor

---

## ๐ Troubleshooting

### ะัะพะฑะปะตะผะฐ: cAdvisor ะฝะต ะฒะธะดะธั ะบะพะฝัะตะนะฝะตัั

**ะะตัะตะฝะธะต:**
```bash
# ะัะพะฒะตัะธัั ััะพ Docker socket ะดะพัััะฟะตะฝ
ls -la /var/run/docker.sock

# ะะตัะตะทะฐะฟัััะธัั cAdvisor ั ะฟัะฐะฒะฐะผะธ
docker compose -f docker-compose.monitoring.yml restart cadvisor
```

### ะัะพะฑะปะตะผะฐ: ะััะพะบะฐั ะฝะฐะณััะทะบะฐ ะพั cAdvisor

**ะะตัะตะฝะธะต:**
```bash
# ะฃะฒะตะปะธัะธัั ะธะฝัะตัะฒะฐะป ะพะฟัะพัะฐ (ะฒ docker-compose.monitoring.yml)
command:
  - '--housekeeping_interval=30s'  # ะฒะผะตััะพ 10s
```

### ะัะพะฑะปะตะผะฐ: ะะต ัะฐะฑะพัะฐะตั UI

**ะะตัะตะฝะธะต:**
```bash
# ะัะพะฒะตัะธัั ะฟะพัั
netstat -tulpn | grep 8080

# ะัะพะฒะตัะธัั ะปะพะณะธ
docker logs bizcard-cadvisor --tail 50
```

---

## โ Checklist ะฑััััะพะน ะฟัะพะฒะตัะบะธ

```
โ cAdvisor ะทะฐะฟััะตะฝ (docker ps | grep cadvisor)
โ UI ะดะพัััะฟะตะฝ (http://localhost:8080)
โ ะะตััะธะบะธ ัะพะฑะธัะฐัััั (http://localhost:8080/metrics)
โ Prometheus ัะพะฑะธัะฐะตั ะดะฐะฝะฝัะต (ะฟัะพะฒะตัะธัั targets)
โ Grafana ะฟะพะบะฐะทัะฒะฐะตั ะณัะฐัะธะบะธ
โ ะะปะตััั ะฝะฐัััะพะตะฝั
```

---

**ะกะพะทะดะฐะฝะพ:** 2025-10-25  
**ะะตััะธั:** 1.0  
**ะะฒัะพั:** FastAPI Business Card CRM Team

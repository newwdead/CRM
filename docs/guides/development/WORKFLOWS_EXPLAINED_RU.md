# 🚀 GitHub Workflows - Объяснение простыми словами

## 📖 Содержание
1. [Что такое GitHub Actions и Workflows](#что-такое-github-actions)
2. [Структура проекта](#структура-проекта)
3. [Какие Workflows я создал](#какие-workflows-я-создал)
4. [Что такое Pull Request](#что-такое-pull-request)
5. [Как всё работает вместе](#как-всё-работает-вместе)

---

## 🤔 Что такое GitHub Actions?

**GitHub Actions** = Робот-помощник на GitHub, который автоматически выполняет задачи.

**Workflow** = Инструкция для робота, что и когда делать.

### Аналогия из жизни:

```
Вы пишете код → Отправляете на GitHub → Робот автоматически:
  ✅ Проверяет код на ошибки
  ✅ Собирает программу
  ✅ Запускает тесты
  ✅ Создаёт релиз
  ✅ Публикует в интернете
```

**Без workflows:** Вы делаете всё вручную ⏰ 2-3 часа  
**С workflows:** Робот делает за 5-10 минут ⚡ Автоматически!

---

## 🏗️ Структура проекта

### Визуальная схема:

```
┌─────────────────────────────────────────────────────────────────┐
│  👨‍💻 ВЫ (разработчик)                                            │
│  - Пишете код на компьютере                                     │
│  - Исправляете ошибки                                           │
│  - Добавляете новые функции                                     │
└─────────────────┬───────────────────────────────────────────────┘
                  │
                  │ git push (отправка кода)
                  ↓
┌─────────────────────────────────────────────────────────────────┐
│  🌐 GITHUB (облачное хранилище кода)                            │
│  ┌───────────────────────────────────────────────────────────┐ │
│  │  📂 Репозиторий: newwdead/CRM                             │ │
│  │  - main (главная ветка)                                   │ │
│  │  - tags (v2.8, v2.7, ...)                                 │ │
│  │  - commits (история изменений)                            │ │
│  └───────────────────────────────────────────────────────────┘ │
│                                                                   │
│  ┌───────────────────────────────────────────────────────────┐ │
│  │  🤖 GITHUB ACTIONS (робот-помощник)                       │ │
│  │                                                             │ │
│  │  📋 Workflow #1: CI (Continuous Integration)              │ │
│  │     Запускается: при каждом git push                      │ │
│  │     ✅ Проверяет код                                       │ │
│  │     ✅ Собирает программу                                  │ │
│  │     ✅ Запускает тесты                                     │ │
│  │                                                             │ │
│  │  📋 Workflow #2: Release                                   │ │
│  │     Запускается: при создании тега (v2.8)                 │ │
│  │     📦 Создаёт архив проекта                              │ │
│  │     🐳 Собирает Docker образы                             │ │
│  │     📤 Публикует в GitHub Container Registry              │ │
│  │                                                             │ │
│  │  📋 Workflow #3: Security                                  │ │
│  │     Запускается: каждую неделю (понедельник)              │ │
│  │     🔐 Сканирует код на уязвимости                        │ │
│  │     🛡️ Проверяет зависимости                              │ │
│  └───────────────────────────────────────────────────────────┘ │
│                                                                   │
│  ┌───────────────────────────────────────────────────────────┐ │
│  │  📦 GITHUB CONTAINER REGISTRY (GHCR)                      │ │
│  │  - ghcr.io/newwdead/crm/backend:2.8                       │ │
│  │  - ghcr.io/newwdead/crm/frontend:2.8                      │ │
│  │  - ghcr.io/newwdead/crm/backend:latest                    │ │
│  │  - ghcr.io/newwdead/crm/frontend:latest                   │ │
│  └───────────────────────────────────────────────────────────┘ │
└─────────────────┬───────────────────────────────────────────────┘
                  │
                  │ docker pull (скачивание образов)
                  │ или git clone (клонирование кода)
                  ↓
┌─────────────────────────────────────────────────────────────────┐
│  🖥️ СЕРВЕР PRODUCTION (ibbase.ru)                               │
│  IP: 95.163.183.25                                              │
│                                                                   │
│  ┌───────────────────────────────────────────────────────────┐ │
│  │  🐳 DOCKER COMPOSE                                         │ │
│  │  ├─ bizcard-backend      (FastAPI)                        │ │
│  │  ├─ bizcard-frontend     (React + Nginx)                  │ │
│  │  ├─ bizcard-db           (PostgreSQL)                     │ │
│  │  ├─ bizcard-redis        (Redis)                          │ │
│  │  ├─ bizcard-celery       (Celery Worker)                  │ │
│  │  └─ bizcard-label-studio (Label Studio)                   │ │
│  └───────────────────────────────────────────────────────────┘ │
│                                                                   │
│  ┌───────────────────────────────────────────────────────────┐ │
│  │  🌐 NGINX (Reverse Proxy)                                 │ │
│  │  - Принимает запросы на https://ibbase.ru                │ │
│  │  - Перенаправляет на Docker контейнеры                   │ │
│  │  - Обеспечивает SSL/TLS (HTTPS)                          │ │
│  └───────────────────────────────────────────────────────────┘ │
└─────────────────┬───────────────────────────────────────────────┘
                  │
                  ↓
┌─────────────────────────────────────────────────────────────────┐
│  👥 ПОЛЬЗОВАТЕЛИ                                                │
│  - Открывают https://ibbase.ru                                  │
│  - Работают с визитками                                         │
│  - Используют OCR редактор                                      │
└─────────────────────────────────────────────────────────────────┘
```

---

## 📋 Какие Workflows я создал

### 1. 🔄 CI Workflow (Continuous Integration)

**Файл:** `.github/workflows/ci.yml`

**Когда запускается:**
- ✅ При каждом `git push` в ветку `main`
- ✅ При создании Pull Request
- ✅ Можно запустить вручную

**Что делает:**

```
Шаг 1: Backend проверка
  ├─ Устанавливает Python 3.10
  ├─ Устанавливает зависимости (pip install)
  ├─ Запускает flake8 (проверка стиля кода)
  ├─ Запускает black (проверка форматирования)
  ├─ Проверяет импорты (import fastapi, sqlalchemy...)
  └─ Собирает Docker образ (тестовая сборка)

Шаг 2: Frontend проверка
  ├─ Устанавливает Node.js 18
  ├─ Устанавливает зависимости (npm install)
  ├─ Запускает ESLint (если настроен)
  ├─ Собирает React приложение (npm run build)
  └─ Собирает Docker образ (тестовая сборка)

Шаг 3: Docker Compose проверка
  └─ Проверяет валидность docker-compose.yml

Результат:
  ✅ Зелёная галочка - всё хорошо, код можно деплоить
  ❌ Красный крестик - есть ошибки, нужно исправить
```

**Зачем это нужно:**
- 🛡️ Поймать ошибки ДО того, как они попадут на production
- 🚦 Убедиться, что код работает
- 👥 Если работаете в команде - убедиться, что код коллег не сломал проект

---

### 2. 📦 Release Workflow

**Файл:** `.github/workflows/release.yml`

**Когда запускается:**
- ✅ При создании тега (например, `v2.8`)
- ✅ Можно запустить вручную

**Что делает:**

```
Шаг 1: Создание релиза на GitHub
  ├─ Определяет версию из тега (v2.8 → 2.8)
  ├─ Создаёт архив проекта (ibbase-v2.8.tar.gz)
  │  └─ Исключает .git, node_modules, временные файлы
  ├─ Находит Release Notes (RELEASE_NOTES_v2.8.md)
  └─ Публикует релиз на GitHub с архивом

Шаг 2: Сборка Docker образов
  ├─ Backend:
  │  ├─ Собирает Docker образ из backend/Dockerfile
  │  ├─ Тегирует: ghcr.io/newwdead/crm/backend:2.8
  │  ├─ Тегирует: ghcr.io/newwdead/crm/backend:latest
  │  └─ Публикует в GitHub Container Registry
  │
  └─ Frontend:
     ├─ Собирает Docker образ из frontend/Dockerfile
     ├─ Тегирует: ghcr.io/newwdead/crm/frontend:2.8
     ├─ Тегирует: ghcr.io/newwdead/crm/frontend:latest
     └─ Публикует в GitHub Container Registry

Результат:
  📦 Архив для скачивания
  🐳 Docker образы в GHCR
  📝 Красивая страница релиза на GitHub
```

**Зачем это нужно:**
- 📚 История версий проекта
- 💾 Возможность откатиться на старую версию
- 🐳 Готовые Docker образы для быстрого деплоя
- 📊 Changelog и Release Notes для пользователей

---

### 3. 🔐 Security Workflow

**Файл:** `.github/workflows/security.yml`

**Когда запускается:**
- ✅ Каждый понедельник в 00:00 UTC
- ✅ При каждом push и Pull Request
- ✅ Можно запустить вручную

**Что делает:**

```
Шаг 1: Trivy сканирование
  ├─ Сканирует файловую систему
  ├─ Сканирует Docker образы
  ├─ Находит уязвимости (CRITICAL, HIGH)
  └─ Генерирует отчёт SARIF

Шаг 2: Dependency Review
  └─ Проверяет новые зависимости в PR

Шаг 3: Python безопасность
  └─ Запускает safety для проверки pip пакетов

Шаг 4: Node.js безопасность
  └─ Запускает npm audit для проверки npm пакетов

Результат:
  ✅ Отчёт о безопасности в GitHub Security
  🚨 Алерты о найденных уязвимостях
  📊 SARIF файлы для анализа
```

**Зачем это нужно:**
- 🛡️ Защита от известных уязвимостей
- 🚨 Раннее обнаружение проблем безопасности
- 📈 Соответствие стандартам безопасности

---

## 🤝 Что такое Pull Request (PR)?

### Простое объяснение:

**Pull Request** = "Привет, я сделал изменения, пожалуйста, проверь и добавь в основной проект"

### Аналогия из жизни:

Представьте, что вы пишете книгу вместе с другом:

```
Обычный подход (без PR):
  Друг: "Я написал главу 5, сейчас вставлю её в книгу"
  Вы: "Стоп! Я тоже писал главу 5, теперь всё сломано!"

Подход с Pull Request:
  Друг: "Я написал главу 5, вот она [создаёт PR]"
  Вы: "Дай посмотрю... [проверяете]"
  Вы: "Тут опечатка, исправь [комментарий в PR]"
  Друг: "Исправил [обновляет PR]"
  Вы: "Отлично! [одобряете и мержите PR]"
  → Глава добавлена в книгу без конфликтов
```

### Как это выглядит в GitHub:

```
1. Создание ветки:
   main ─────────────────────> (основная версия)
         \
          feature/new-button ──> (ваши изменения)

2. Создание Pull Request:
   "Я добавил новую кнопку, проверьте!"
   
3. Проверка:
   - 🤖 CI Workflow автоматически проверяет код
   - 👀 Коллеги смотрят изменения
   - 💬 Оставляют комментарии
   
4. Merge (слияние):
   main ─────────────────────────────> (теперь с вашей кнопкой)
         \                           ↗
          feature/new-button ───────┘
```

### Зачем нужен Pull Request:

✅ **Code Review** - другие проверяют ваш код  
✅ **Автотесты** - CI автоматически тестирует изменения  
✅ **Обсуждение** - можно обсудить подход к решению  
✅ **История** - видно, кто, что и зачем изменил  
✅ **Безопасность** - нельзя случайно сломать main ветку  

---

## 🔄 Как всё работает вместе

### Сценарий 1: Обычная разработка

```
День 1: Добавляем новую функцию
  👨‍💻 Вы пишете код на компьютере
     ↓
  💾 git add . && git commit -m "feat: Add export to Excel"
     ↓
  🚀 git push origin main
     ↓
  🌐 GitHub получает код
     ↓
  🤖 CI Workflow автоматически запускается
     ├─ ✅ Backend проверки
     ├─ ✅ Frontend сборка
     └─ ✅ Docker тесты
     ↓
  ✅ Зелёная галочка = всё хорошо
  ❌ Красный крестик = есть ошибки, исправьте
```

### Сценарий 2: Создание релиза

```
День релиза: Выпускаем v2.9
  👨‍💻 Создаёте RELEASE_NOTES_v2.9.md
     ↓
  💾 git add . && git commit -m "chore: Prepare release v2.9"
  🚀 git push origin main
     ↓
  🏷️ git tag -a v2.9 -m "Release v2.9"
  🚀 git push origin v2.9
     ↓
  🌐 GitHub видит новый тег
     ↓
  🤖 Release Workflow автоматически запускается
     ├─ 📦 Создаёт архив ibbase-v2.9.tar.gz
     ├─ 📝 Публикует релиз с Release Notes
     ├─ 🐳 Собирает Docker образы
     └─ 📤 Публикует в GHCR
     ↓
  🎉 Релиз готов!
```

### Сценарий 3: Деплой на сервер

```
Обновление production сервера
  🌐 GitHub Container Registry
     ├─ ghcr.io/newwdead/crm/backend:2.9
     └─ ghcr.io/newwdead/crm/frontend:2.9
     ↓
  🖥️ SSH подключение к серверу (95.163.183.25)
     ↓
  👨‍💻 cd /home/ubuntu/fastapi-bizcard-crm-ready
     ↓
  📥 git pull origin main
     ↓
  🐳 docker compose up -d --build
     ├─ Скачивает новый код
     ├─ Собирает новые образы
     ├─ Перезапускает контейнеры
     └─ Обновляет базу данных (если нужно)
     ↓
  ✅ Проверка: curl https://ibbase.ru/version
     {"version": "v2.9", "message": "..."}
     ↓
  🌐 Пользователи видят обновление
```

---

## 📊 Визуализация процесса разработки

```
┌─────────────────────────────────────────────────────────────────┐
│  РАЗРАБОТКА (на вашем компьютере)                               │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐                      │
│  │  Код     │→ │  Тест    │→ │  Commit  │                      │
│  └──────────┘  └──────────┘  └──────────┘                      │
└────────────────────────┬────────────────────────────────────────┘
                         │ git push
                         ↓
┌─────────────────────────────────────────────────────────────────┐
│  GITHUB (облако)                                                │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │  CI Workflow (автоматическая проверка)                   │  │
│  │  ✓ Линтеры  ✓ Тесты  ✓ Сборка  ✓ Docker                 │  │
│  └──────────────────────────────────────────────────────────┘  │
│                         │                                        │
│                         ├─ ✅ OK → продолжаем                   │
│                         └─ ❌ ERROR → исправляем и заново       │
└────────────────────────┬────────────────────────────────────────┘
                         │ Создание тега (v2.9)
                         ↓
┌─────────────────────────────────────────────────────────────────┐
│  RELEASE (автоматическое создание релиза)                       │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │  Release Workflow                                         │  │
│  │  📦 Архив  📝 Notes  🐳 Docker  📤 Publish               │  │
│  └──────────────────────────────────────────────────────────┘  │
└────────────────────────┬────────────────────────────────────────┘
                         │ Готово к деплою
                         ↓
┌─────────────────────────────────────────────────────────────────┐
│  PRODUCTION (сервер ibbase.ru)                                  │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │  docker compose up -d --build                             │  │
│  │  Backend | Frontend | DB | Redis | Celery                │  │
│  └──────────────────────────────────────────────────────────┘  │
└────────────────────────┬────────────────────────────────────────┘
                         │ https://ibbase.ru
                         ↓
┌─────────────────────────────────────────────────────────────────┐
│  ПОЛЬЗОВАТЕЛИ                                                   │
│  👥 Работают с приложением                                      │
└─────────────────────────────────────────────────────────────────┘
```

---

## 🎯 Что с этим делать?

### Для обычной разработки:

```bash
# 1. Пишете код
# 2. Сохраняете изменения
git add .
git commit -m "fix: Исправил баг"
git push origin main

# 3. Идёте на GitHub → Actions → смотрите результат
# 4. Если зелёная галочка ✅ - всё хорошо
# 5. Если красный крестик ❌ - читаете логи, исправляете
```

### Для создания релиза:

```bash
# 1. Создаёте Release Notes
nano RELEASE_NOTES_v2.9.md

# 2. Обновляете версию в docker-compose.yml
# APP_VERSION=v2.9

# 3. Коммитите и создаёте тег
git add .
git commit -m "chore: Prepare release v2.9"
git push origin main
git tag -a v2.9 -m "Release v2.9"
git push origin v2.9

# 4. Идёте на GitHub → Actions → смотрите как создаётся релиз
# 5. После завершения → Releases → видите свой релиз
```

### Для деплоя на сервер:

```bash
# SSH на сервер
ssh ubuntu@95.163.183.25

# Переходим в проект
cd /home/ubuntu/fastapi-bizcard-crm-ready

# Обновляем код
git pull origin main

# Перезапускаем Docker
docker compose up -d --build

# Проверяем версию
curl -s http://localhost:8000/version | python3 -m json.tool
```

---

## 🔧 Работа с Pull Requests

### Если вы работаете один:

**Вам не нужны Pull Requests!** Просто push в main.

### Если работаете в команде:

```bash
# 1. Создаёте ветку для новой функции
git checkout -b feature/add-export

# 2. Пишете код, коммитите
git add .
git commit -m "feat: Add Excel export"
git push origin feature/add-export

# 3. Идёте на GitHub → Pull Requests → New Pull Request
# 4. Выбираете: base: main ← compare: feature/add-export
# 5. Пишете описание, что сделали
# 6. Нажимаете "Create Pull Request"

# 7. CI автоматически проверит ваш код
# 8. Коллеги посмотрят и одобрят
# 9. Вы нажимаете "Merge Pull Request"
# 10. Ветка сливается в main
```

---

## 📈 Преимущества этой системы

### До workflows (ручная работа):

```
❌ Время на проверку: 2-3 часа
❌ Человеческие ошибки: часто
❌ Забыл запустить тесты: регулярно
❌ Сломал production: возможно
❌ Откат версии: сложно
❌ История изменений: нечёткая
```

### С workflows (автоматизация):

```
✅ Время на проверку: 5-10 минут
✅ Человеческие ошибки: минимум
✅ Тесты: всегда автоматически
✅ Сломать production: очень сложно
✅ Откат версии: 1 команда
✅ История изменений: полная
```

---

## 🚀 Быстрая шпаргалка

### Ежедневная разработка:

```bash
git add .
git commit -m "ваше сообщение"
git push origin main
# → Смотрите GitHub Actions для проверки
```

### Создание релиза:

```bash
# Подготовка
nano RELEASE_NOTES_v2.X.md
# Обновите APP_VERSION в docker-compose.yml

# Публикация
git add .
git commit -m "chore: Prepare release v2.X"
git push origin main
git tag -a v2.X -m "Release v2.X"
git push origin v2.X
# → GitHub автоматически создаст релиз
```

### Деплой на production:

```bash
ssh ubuntu@95.163.183.25
cd /home/ubuntu/fastapi-bizcard-crm-ready
git pull origin main
docker compose up -d --build
```

---

## 📚 Полезные ссылки

- **GitHub Actions Docs:** https://docs.github.com/en/actions
- **Ваши Workflows:** https://github.com/newwdead/CRM/actions
- **Ваши Releases:** https://github.com/newwdead/CRM/releases
- **Docker Images (GHCR):** https://github.com/newwdead?tab=packages&repo_name=CRM

---

## ❓ FAQ

**Q: Что делать, если CI упал с ошибкой?**  
A: Идите в Actions → кликните на failed job → смотрите логи → исправляйте ошибку → push снова.

**Q: Как удалить неудачный релиз?**  
A: GitHub → Releases → найдите релиз → Delete. Затем удалите тег:
```bash
git tag -d v2.X
git push origin :refs/tags/v2.X
```

**Q: Нужно ли запускать workflows вручную?**  
A: Нет! Они запускаются автоматически. Но можно запустить вручную через GitHub Actions → Run workflow.

**Q: Сколько стоят GitHub Actions?**  
A: Для публичных репозиториев - **бесплатно**! Для приватных - 2000 минут/месяц бесплатно.

**Q: Можно ли отключить какой-то workflow?**  
A: Да, просто удалите или переименуйте файл `.yml` в `.github/workflows/`.

---

**Создано:** 20 октября 2025  
**Версия:** 2.8  
**Автор:** AI Assistant + newwdead

---

**🎉 Теперь у вас полностью автоматизированный CI/CD pipeline!**

